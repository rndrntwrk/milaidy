name: Integration DoD Gap Issues

on:
  schedule:
    # Nightly at 03:30 UTC
    - cron: "30 3 * * *"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Parse report and log actions without mutating issues"
        required: false
        type: boolean
        default: false
      close_resolved_gaps:
        description: "Close managed issues that are no longer in the report"
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  issues: write

concurrency:
  group: integration-dod-gap-issues
  cancel-in-progress: false

jobs:
  sync-gap-issues:
    name: Sync gap issues from INTEGRATION_DOD_MAP.md
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Sync issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INTEGRATION_DOD_REPORT: INTEGRATION_DOD_MAP.md
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run || 'false' }}
          CLOSE_RESOLVED_GAPS: ${{ github.event_name == 'workflow_dispatch' && inputs.close_resolved_gaps || 'true' }}
        run: node scripts/sync-dod-gap-issues.mjs

