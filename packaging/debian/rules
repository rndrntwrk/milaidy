#!/usr/bin/make -f

%:
	dh $@

override_dh_auto_build:
	# Use bun if available (installed by CI), fallback to npm
	if command -v bun >/dev/null 2>&1; then \
		bun install --frozen-lockfile --ignore-scripts; \
		bun run build; \
	else \
		npm install --ignore-scripts; \
		npm run build; \
	fi

override_dh_auto_install:
	# Install the built distribution
	install -d debian/milady/usr/lib/milady
	cp -r dist/ debian/milady/usr/lib/milady/
	cp milady.mjs debian/milady/usr/lib/milady/
	cp package.json debian/milady/usr/lib/milady/
	cp -r node_modules/ debian/milady/usr/lib/milady/ 2>/dev/null || true

	# Install the plugins manifest
	install -m 644 plugins.json debian/milady/usr/lib/milady/

	# Create the CLI wrapper
	install -d debian/milady/usr/bin
	printf '#!/bin/sh\nexec /usr/bin/node /usr/lib/milady/milady.mjs "$$@"\n' \
		> debian/milady/usr/bin/milady
	chmod 755 debian/milady/usr/bin/milady

override_dh_auto_test:
	# Skip tests during package build
	true

override_dh_auto_clean:
	rm -rf dist/ node_modules/
	dh_auto_clean
