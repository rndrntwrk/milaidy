# Flatpak manifest for Milady
# Build: flatpak-builder --repo=repo build-dir ai.milady.Milady.yml
# Install: flatpak --user install repo ai.milady.Milady

app-id: ai.milady.Milady
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: milady

finish-args:
  # Network access (for AI providers, plugin downloads)
  - --share=network
  # Filesystem access (for config, workspace, plugins)
  - --filesystem=home
  # D-Bus access (for desktop notifications)
  - --talk-name=org.freedesktop.Notifications
  # Allow binding to localhost for web dashboard
  - --share=ipc

modules:
  # ── Node.js 22 ─────────────────────────────────────────────────────────
  - name: nodejs
    buildsystem: simple
    build-commands:
      - install -D -m 755 bin/node /app/bin/node
      - install -D -m 755 bin/npm /app/bin/npm
      - install -D -m 755 bin/npx /app/bin/npx
      - cp -r lib /app/lib
    sources:
      - type: archive
        # Node.js 22.x for x86_64 — update URL + sha256 for each release
        url: https://nodejs.org/dist/v22.12.0/node-v22.12.0-linux-x64.tar.xz
        sha256: "22982235e1b71fa8850f82edd09cdae7e3f32df1764a9ec298c72d25ef2c164f"
        only-arches:
          - x86_64
      - type: archive
        url: https://nodejs.org/dist/v22.12.0/node-v22.12.0-linux-arm64.tar.xz
        sha256: "8cfd5a8b9afae5a2e0bd86b0148ca31d2589c0ea669c2d0b11c132e35d90ed68"
        only-arches:
          - aarch64

  # ── Milady ────────────────────────────────────────────────────────────
  - name: milady
    buildsystem: simple
    build-options:
      env:
        npm_config_nodedir: /app
    build-commands:
      # Install milady globally
      - npm install -g miladyai --prefix=/app

      # Create wrapper script
      - |
        cat > /app/bin/milady << 'WRAPPER'
        #!/bin/sh
        export NODE_PATH="/app/lib/node_modules"
        exec /app/bin/node /app/lib/node_modules/milady/milady.mjs "$@"
        WRAPPER
      - chmod +x /app/bin/milady

      # Install desktop entry
      - install -D -m 644 ai.milady.Milady.desktop /app/share/applications/ai.milady.Milady.desktop
      - install -D -m 644 ai.milady.Milady.metainfo.xml /app/share/metainfo/ai.milady.Milady.metainfo.xml

    sources:
      - type: file
        path: ai.milady.Milady.desktop
      - type: file
        path: ai.milady.Milady.metainfo.xml
