# ─────────────────────────────────────────────────────────────────────────────
# ElizaOS Cloud Agent Container
#
# Pre-built image for deploying ElizaOS agents to ElizaCloud (AWS ECS).
# Runs an ElizaOS agent runtime with the ElizaCloud plugin for inference,
# exposes a health endpoint on $PORT (default 2138), and a bridge HTTP
# server on $BRIDGE_PORT (default 18790) for communication with milady.
#
# Configuration is injected via environment variables:
#   ELIZAOS_CLOUD_API_KEY — for cloud inference
#   OPENAI_API_KEY / ANTHROPIC_API_KEY — for BYOK mode
#   SMALL_MODEL / LARGE_MODEL — model selection
#
# Build:
#   docker build -f deploy/Dockerfile.cloud-agent -t elizaos/agent:latest .
#
# Run:
#   docker run -p 2138:2138 -p 18790:18790 \
#     -e ELIZAOS_CLOUD_API_KEY=eliza_xxx \
#     elizaos/agent:latest
# ─────────────────────────────────────────────────────────────────────────────

FROM node:22-bookworm-slim

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      curl ca-certificates && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy the entrypoint (standalone Node.js script, no build step needed)
COPY deploy/cloud-agent-entrypoint.ts ./entrypoint.ts

# Install tsx for running TypeScript directly
RUN npm install -g tsx@4

ENV NODE_ENV=production
ENV PORT=2138
ENV BRIDGE_PORT=18790

# Health check endpoint
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
  CMD curl -f http://localhost:${PORT}/health || exit 1

EXPOSE ${PORT}
EXPOSE ${BRIDGE_PORT}

# Security: run as non-root
RUN useradd -m agent
USER agent

CMD ["tsx", "entrypoint.ts"]
